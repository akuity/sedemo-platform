apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  annotations:
    kargo.akuity.io/color: red
  name: dev
  namespace: team-eddie
spec:
  promotionTemplate:
    spec:
      steps:
        - config:
            checkout:
              - branch: ${{ vars.sourceBranch }}
                path: ${{ vars.path_src }}
            repoURL: ${{ vars.gitRepo }}
          uses: git-clone
        - uses: yaml-update
          config:
            path: ./src/akuity.yaml
            updates:
            - key: value
              value: ${{ ctx.promotion }}
        # make temp commit
        # push it
        # http get tree - https://api.github.com/repos/eddiewebb/circleci-samples/commits/47d3bb412470df0d3782c0456aba5dae658a0f67
        # http make commit from tree - gh api -X POST repos/<team>/<repo>/git/commits -f "message=Verified commit with large files!" \
        #  -f "tree=$TREE_SHA" -f "parents[]=<parent commit hash>"
        # http update reference - -X PATCH repos/<team>/<repo>/git/refs/heads/<branch> -f "sha=<new commit hash>"
        # delete temp commit
        - uses: git-commit
          as: commit
          config:
            path: ${{ vars.path_src }}
            message: "Writecommitfor ${{ ctx.promotion }}"
            author:
              #your-app-name[bot]
              name: akuity-signing-demo[bot]
              #app-user-id+your-app-name[bot]@users.noreply.github.com
              #JSON Schema email format does not support the brackets [] used by Github :(
              email: "261204081+akuity-signing-demo@users.noreply.github.com"
        - uses: git-push
          as: push
          config:
            path: ${{ vars.path_src }}
            generateTargetBranch: true
        - uses: compose-output
          as: vars
          config:
            outputs:
              - name: jwt
                value: ${{ secret('app-jwt').jwt }}
              - name: commit
                value: ${{ outputs['push'].commit }}
              - name: commitUrl
                value: ${{ outputs['push'].commit }}
        - uses: http
          as: get-commit
          config:
            url: "https://api.github.com/repos/eddiewebb/circleci-samples/commits/${{ outputs['push'].commit }}"
            timeout: 10s
            outputs:
              - name: tree
                fromExpression: response.body.commit.tree.sha
              - name: parent
                fromExpression: response.body.parents[0].sha
        #-f "message=Verified commit with large files!"     -f "tree=$TREE_SHA" -f "parents[]=<parent commit hash>"
        # installation ID 109677952
        - uses: http
          as: get-token
          config:
            method: POST
            url: https://api.github.com/app/installations/109677952/access_tokens
            headers:
            - name: Authorization
              value: "Bearer ${{ secret('app-jwt').jwt }}"
            failureExpression: response.status != 201
            successExpression: response.status == 201
            outputs:
              - name: token
                fromExpression: response.body.token
        - uses: http
          as: create-tree
          config:
            method: POST
            url: https://api.github.com/repos/eddiewebb/circleci-samples/git/trees
            headers:
            - name: Authorization
              value: "Bearer ${{ outputs['get-token'].token }}"
            failureExpression: response.status != 200
            body: |
              ${{ quote({
                "message":"signing commit",
                "tree": outputs['get-commit'].tree ,
                "parents":[ outputs['get-commit'].parent ]
                }) 
              }}
        # http update reference - -X PATCH repos/<team>/<repo>/git/refs/heads/<branch> -f "sha=<new commit hash>"
        - uses: http
          as: update-ref
          config:
            method: PATCH
            url: https://api.github.com/repos/eddiewebb/circleci-samples/git/refs/heads/main
            headers:
            - name: Authorization
              value: "Bearer ${{ outputs['get-token'].token }}"
            - name: Accept
              value: "application/vnd.github+json"
            - name: X-GitHub-Api-Version
              value: "2022-11-28"
            failureExpression: response.status != 200
            body: |
              ${{ quote({
                "sha": ${outputs['create-tree'].body.sha},
                }) }}
        
      vars:
        - name: gitRepo
          value: https://github.com/eddiewebb/circleci-samples
        - name: sourceBranch
          value: main
        - name: path_src
          value: ./src
  requestedFreight:
    - origin:
        kind: Warehouse
        name: team-eddie
      sources:
        direct: true

